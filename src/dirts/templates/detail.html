{% extends "base.html" %}

{% block content %}
{% with dirt=model.as_domainmodel %}
<!--<div class="container-fluid">-->
  <div>
    <div class="row">
      <div class="additional-links col-lg-12">
        {% if comment_count %}
        <a href="{% url 'defects:defect-comments:list' dirt.id %}">View comments ({{ comment_count }})</a>
        {% else %}
        <a href="{% url 'defects:defect-comments:list' dirt.id %}">Add comments/notes</a>
        {% endif %}
      </div>
      <div class="col-lg-3 col-lg-push-9">
        <div class="list-group z-height-1">
          {% if dirt.is_active %}
          <a href="{% url 'defects:amend' dirt.id %}" class="list-group-item">Amend</a>
          <a href="{% url 'defects:close' dirt.id %}" class="list-group-item">Close</a>
          {% elif dirt.is_locked %}
          {% else %}
          <a href="{% url 'defects:lock' dirt.id %}" class="list-group-item">Make obsolete</a>
          <a href="{% url 'defects:reopen' dirt.id %}" class="list-group-item">Re-open</a>
          {% if user.is_staff %}
          <a href="{% url 'defects:delete' dirt.id %}" class="list-group-item">Delete</a>
          {% endif %}
          {% endif %}
          <a href="{% url 'defects:create-similar' dirt.id %}" class="list-group-item">Raise similar</a>              
          <a href="{% url 'defects:tags' dirt.id %}" class="list-group-item">Add/Edit tags</a>           
        </div>

        <h4>Navigate {{ dirt.project_code }}:</h4>                    
        <div class="list-group z-height-1">
          {% if model.prev_in_project %}
          <a href="{{ model.prev_in_project.get_absolute_url }}" class="list-group-item">Previous</a>
          {% endif %}
          {% if model.next_in_project %}
          <a href="{{ model.next_in_project.get_absolute_url }}" class="list-group-item">Next</a>
          {% endif %}            
        </div>
        
        {% with more_like_this=model.more_like_this %}
        {% if more_like_this %}
        <h4>More like this:</h4>
        <div id="more-like-this" class="list-group z-height-1">
          {% for similar in more_like_this %}
          <a href="{% url 'defects:detail' similar.id %}" class="list-group-item">
            {{similar.reference}} [{{similar.date_created | timesince}} ago]
          </a>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
      </div>
      <div class="col-lg-9 col-lg-pull-3">
        {% if dirt.is_active %}
        <div class="panel panel-info">
        {% else %}
        <div class="panel panel-default">
        {% endif %}
          <div class="panel-heading">
            <h1 class="panel-title">
                {{ dirt.reference }} ({{ dirt.status }})
                [Last updated {{ dirt.date_changed | timesince }} ago]
            </h1>
          </div>
          <div class="panel-body">
            <h4>Release ID: {{ dirt.release_id }}</h4>
            <h4>Raised by {{ dirt.submitter }}, {{ dirt.date_created }}</h4>
            <h4>Priority: {{ dirt.priority }}</h4>
          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <p>{{ dirt.description | linebreaksbr }}</p>
          </div>
        </div>
        {% if dirt.comments %}
        <div class="panel panel-default">
          <div class="panel-heading">Comments:</div>
          <div class="panel-body">
            <p>{{ dirt.comments | linebreaksbr }}</p>
          </div>
        </div>
        {% endif %}
        {% with tags=model.tags.all %}
        {% if tags %}
        <p>Tags:
        {% for tag in tags %}
            <u><a href="{% url 'defects:filter-by-tag' tag.slug %}">#{{tag}}</a></u>
        {% endfor %}
        </p>
        {% endif %}
        {% endwith %}
      </div>
    </div>
    {% if dirt.change_history %}
    <div class="row">
      <div class="col-lg-12">
        <hr>
        <h5>Change history</h5>
        <table id="history-list" class="table table-striped table-condensed">
          <tbody>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Modified by</th>
            </tr>
            {% for change in dirt.change_history %}
            <tr>
              <td>
                  {{ change.date_created | date:"d-m-Y f a" }}
                  ({{ change.date_created | timesince }} ago)
              </td>
              <td class="desc">{{ change.description | linebreaksbr }}</td>
              <td>{{ change.submitter }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>
<!--</div>-->
{% endwith %}

{% endblock %}
